# 51% 공격

본 실험은 51% 공격(Majority Attack)을 구현하는것을 목표로 한다.



비트코인에서는 언제나 가장 긴 블록이 정식 블록이라 생각하고 채택한다.

그래서 정상적인 사용자가 가진 해시 연산력보다 악의적인 사용자가 더 큰 연산력을 가지게 된다면 정상적인 사용자들보다 더 빠르게 블록을 생성해 저장할수 있다.

이점을 악의적인 사용자들은 이용해 거래가 담겨있는 블록을 조작한 후 정상적인 사용자들보다 더 빠르게 만든다면 악의적인 사용자들의 블록이 정식 블록으로 채택이 되고 블록체인 안에서 일어나는 거래들이 공격을 받게 된다.

이를 보기쉽게 그림으로 표현하면 


<img width="419" alt="스크린샷 2020-06-19 오후 1 10 52" src="https://user-images.githubusercontent.com/33947681/85098514-e698b600-b235-11ea-85b1-8ba7b7d4caaa.png">

비트코인에서 사용자들간의 거래가 일어나게 되면 해당 거래 내용은 블록에 담겨 저장이 된다. 

그림에는 3번 블록에 사용자들의 거래가 저장되었다.


<img width="917" alt="스크린샷 2020-06-19 오후 1 22 10" src="https://user-images.githubusercontent.com/33947681/85098516-e7314c80-b235-11ea-8eed-95fc1ff9d8fa.png">

그다음 정상적인 사용자들이 4번째 블록을 만들고 있을때 악의적인 사용자가 조작한 블록을 5번째까지 미리 만들어 정상적인 사용자들과 연결을 한다면 정식 블록이 파란색 블록에서 빨간색 블록으로 바뀌게 된다. 

이로인해 정상적 사용자들이 3번째 블록에 넣었던 거래 내역이 사라지게 된다.

비트코인에서는 이를 막기 위해 컨펌 조정이라는 방식을 사용한다.

여기서의 컨펌이라는건 말 그대로 확인을 의미한다. 

내 거래가 기록된 블록으로부터 몇개의 블록이 더 생성이 되었는지를 확인하는 것이다.

<img width="709" alt="스크린샷 2020-06-19 오후 2 38 32" src="https://user-images.githubusercontent.com/33947681/85100236-953ef580-b23a-11ea-8411-c99d647a3a4f.png">

이를 통해 악의적인 사용자들이 내 거래를 공격하기 위해서는 



51% 공격이란 


51% 공격이란 블록체인에 참여하는 개인이나 집단이 전체 시스템의 해시 연산력중 50%를 초과하여 보유한 뒤 거래정보를 조작하여 이익을 얻으려고 하는 행위를 말한다.

이는 다른 정직한 사용자들보다 빠르게 블록을 생산할수 있는 능력을 가지고 위조된 블록을 생성후 전파하여 정식블록으로 채택하게 하는 방법이 있다.

비트코인에서는 언제나 가장 긴 블록이 표준이라 생각하고 채택하기에 가능한 공격이다.

그래서 비트코인에서는 이를 막기 위해 6컨펌이라는 방식을 사용한다.

6컨펌이란 거래 기록이 저장된 블록을 1컨펌 이라 할때 그 다음생성된 블록은 2컨펌이라 부르고 이러한 방식으로 6컨펌이 되었을때 1컨펌에 저장된 거래가 확정되는 방식을 이야기 한다.

이는 6컨펌이 진행되는 동안 1컨펌 블록이 사람들에게 전파가 되고 해당 블록에 있는 거래가 이중지불된 거래인지 아니면 위변조된 데이터인지 확인하는 과정을 6컨펌이 진행되는동안 거치게 된다. 

비트코인에서는 6컨펌이 진행된다면 그 이전 블록이 51% 공격에 위조될 확률은 1% 미만이기 때문에 6컨펌을 이용하는게 안전하다고 이야기한다.

따라서 본 실험에서는 6컨펌이 진행된 이후 거래가 확정이 됬을때 51% 공격을 진행한다면 확정된 거래도 무효가 되는지 확인할 예정이다.









&&&&&&&&&&      실험 시나리오       &&&&&&&&&&




1. 영석코인의 459번째 블록을 만든후 공격자가 정상적유저1에게 1000YSC를 보낸다. 

2. 공격자는 정상적 유저와 연결을 끊고 460번째 블록부터 467번째 블록까지 만든다..

  2-1. 이때 공격자가 만든 블록은 본인에게 돌아가는 블록보상을 제외하고 어느 트랜잭션도 포함시키지 않는다.

3. 정상적인 유저들도 460번째 블록에 정상적유저1에 1000YSC가 전송된 거래를 포함한 블록을 생성후 466번째 블록까지 만든다.

4. 공격자는 정상적인 유저와 끊었던 연결을 다시 연결한다.
  
  4-1. 이때 정상적인 유저들의 460번째 블록에 담긴 거래가 어떻게 변화하는지 확인한다.
  



..


 

&&&&&&&&&&      실험 환경       &&&&&&&&&&

실험환경은 비트코인 하드포크를 진행해 영석코인을 만들고 진행하였다.

해시파워의 경우 cpuminer(cpu채굴기)를 이용해 각각 블록을 100개씩 생성하였을때 나온 해시파워의 평균값을 기준으로 하였다.

이때 공격자는 평균 40928 khash/s 가 측정되었고 정상적인 유저는 평균 10145.5 khash/s가 측정되었다.

그래서 같은 환경의 정상적인 유저를 4명이라 가정하였고 이때 해시파워는 40580 khash/s가 되어 

공격자 50.2% 정상적인 유저들 49.8% 해시파워를 가진 환경을 구성하였다.

..











다음 사진은 실제 생성된 블록들의 해시값을 가져와 보여준다.

[정상적 유저들이 만든 459번 블록부터 466번 블록의 블록해시값]

<img width="496" alt="정상적 사용자 해시블록" src="https://user-images.githubusercontent.com/33947681/84633873-ffe6ed00-af2b-11ea-80ae-6cba94fbac7e.png">

[정상적인 유저들이 만든 459번 블록과 공격자가 만든 460~467번 블록의 블록 해시값]

<img width="328" alt="공격자가 만든 블록해시" src="https://user-images.githubusercontent.com/33947681/84633879-01b0b080-af2c-11ea-84cb-82b204de2aaf.png">


이를 보기 쉽게 그림으로 표현하면

[정상적 유저와 공격자가 만든 블록 해시값]
<img width="1033" alt="정상적 유저와 공격자 해시값" src="https://user-images.githubusercontent.com/33947681/84632282-a1b90a80-af29-11ea-85a2-7c73c745d5d9.png">

위의 사진과 같은 해시값을 가지는 블록을 생산하였다.


이때 정상적유저1은 1000YSC를 받고 6컨펌이 지났기에 1000YSC의 거래를 확정짓고 본인 잔액에 포함시킨다.

[6컨펌 이후 확정된 트랜잭션] 

<img width="472" alt="벤치1컴 6컨펌 이후 1000비트코인 전송 트랜잭션 상태 복사본" src="https://user-images.githubusercontent.com/33947681/84633886-04130a80-af2c-11ea-9c85-da3e7a1687bd.png">


[6컨펌 이후 확정된 잔액]

<img width="526" alt="공격전 잔액" src="https://user-images.githubusercontent.com/33947681/84633882-02e1dd80-af2c-11ea-8ed8-eca6a611b127.png">


마지막으로 공격자는 본인의 블록을 정상적인 유저들과 연결한다.

[공격받은 정상적유저1이 공격자의 블록을 동기화 하는 사진]
<img width="656" alt="스크린샷 2020-06-17 오후 6 20 27" src="https://user-images.githubusercontent.com/33947681/84880299-52104580-b0c7-11ea-8578-b5a3f4f2fc8c.png">

[6컨펌 이후 공격받은 정상적 유저1의 잔액]

<img width="1025" alt="스크린샷 2020-06-17 오후 7 01 19" src="https://user-images.githubusercontent.com/33947681/84982059-cd7a0180-b170-11ea-937a-4846407bb28b.png">



이 사진에서 알수있는점은 공격자가 정상적인 유저들보다 블록을 하나 더 만들었기에 공격자의 블록이 정상적인 블록이라 판단하게 된다.

그래서 공격자와 블록값이 달라지는 시점인 460번째 블록부터 467번째 블록까지는 기존의 블록을 버리고 공격자의 블록과 동기화 한다.

또한 정상적인 유저들이 만든 1000YSC가 포함된 460번째 블록이 사라지게 되므로 정상적인 유저1이 받았던 1000YSC또한 사용가능한 잔액에서 사라지고 1000YSC는 보류된 금액이 된다.


이를통해 거래가 확정되는 6컨펌 이후에도 51% 공격이 일어나게 된다면 거래내역이 과거로 돌아가게 되는 치명적인 공격이 일어날수 있음을 확인하였다.
